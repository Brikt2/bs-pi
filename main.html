<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Infoskjerm</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;900&display=swap');

        :root {
            --primary-color: #d6001c;  
            --text-color: #1a1a1a;
            --background-color: #f5f5f5;
            --departure-bg: #ffffff;
            --realtime-color: #4caf50;
            --box-radius: 12px;
            --box-shadow: 0 2px 6px rgba(0,0,0,0.08);
            --font-lineName: "Inter", sans-serif;
        }

        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
            overflow: hidden; /* we scale to fit, so no scrolling */
            background: var(--background-color);
            color: var(--text-color);
            -webkit-font-smoothing:antialiased;
            -moz-osx-font-smoothing:grayscale;
        }

        /* Outer app container full viewport, centers the board */
        #app {
            box-sizing: border-box;
            width: 100%;
            height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-end;
            padding: 20px;
        }

        /* The board will be scaled to fit the viewport when necessary */
        #board {
            width: min(1400px, 100%);
            box-sizing: border-box;
            transform-origin: top left;
            transition: transform 180ms ease;
        }

        /* When we need two columns (one per direction) we toggle this */
        #board.columns .directions {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            align-items: start;
        }

        /* General content styles inside board */
        #board h2 {
            padding-top: 20px;
            font-size: clamp(32px, 5vw, 48px);
            font-weight: 900;
            margin-bottom: 16px;
            color: var(--text-color);
            position: relative;
            padding-bottom: 8px;
        }

        #board h2::after {
            content: "";
            display: block;
            width: 60px;
            height: 4px;
            background-color: var(--primary-color);
            margin-top: 4px;
            border-radius: 2px;
        }

        #board h3 {
            font-size: clamp(20px, 3vw, 28px);
            font-weight: 700;
            margin: 24px 0 12px;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        #board h3::before {
            content: "";
            display: block;
            width: 6px;
            height: 100%;
            background-color: var(--primary-color);
            border-radius: 3px;
        }

        .direction {
            /* Each direction contains its heading+list */
            display: flex;
            flex-direction: column;
            gap: 8px;
            min-width: 0; /* allow shrinking in grid */
        }

        .departure-list {
            display: flex;
            flex-direction: column;
            gap: 14px;
        }

        .departures {
            background: var(--departure-bg);
            padding: 16px 20px;
            border-radius: var(--box-radius);
            box-shadow: var(--box-shadow);
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            box-sizing: border-box;
        }

        .departures:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }

        .lineBox {
            display: flex;
            align-items: center;
            gap: 16px;
            min-width: 0;
        }

        .lineNumber {
            background-color: var(--primary-color);
            color: #ffffff;
            font-weight: 700;
            font-size: 24px;  
            display: flex;
            align-items: center;
            justify-content: center;
            width: 56px;          
            height: 56px;
            border-radius: 8px;
            flex-shrink: 0;
        }

        .lineName {
            font-family: var(--font-lineName);
            font-size: 20px;      
            font-weight: 600;
            white-space: nowrap;
            text-overflow: ellipsis;
            overflow: hidden;
            max-width: 32ch;
        }

        .departureTime {
            font-size: 20px;      
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 6px;
            white-space: nowrap;
        }

        .realtimeDot {
            width: 10px;
            height: 10px;
            background: var(--realtime-color);
            border-radius: 50%;
            display: inline-block;
        }

        /* Small screens: reduce sizes a bit */
        @media (max-width: 480px) {
            #app { padding: 10px; }
            .lineNumber { width: 48px; height: 48px; font-size: 20px; }
            .lineName { font-size: 18px; }
            .departureTime { font-size: 18px; }
        }

        .center {
            display: flex;
            flex-direction: row;
            justify-content: center;
            margin: 0;
            padding: 0;
        }

    </style>
</head>
<body>
    <div id="app">
        <div id="board" aria-live="polite">
            <h2>Jakob Kirke</h2>

            <div class="center">
                <div class="directions">
                    <section id="sentrumSection" class="direction" aria-label="Retning sentrum">
                        <h3>Retning sentrum</h3>
                        <div id="departuresSentrum" class="departure-list">Loading...</div>
                    </section>

                    <section id="otherSection" class="direction" aria-label="Den andre retningen">
                        <h3>Den andre retningen</h3>
                        <div id="departuresOtherWay" class="departure-list">Loading...</div>
                    </section>
                </div>
            </div>
        </div>
    </div>

    <script>
        let departuresData = null;

        async function fetchDepartures() {
            const url = "https://api.entur.io/journey-planner/v3/graphql";

            try {
                const response = await fetch(url, {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                        "ET-Client-Name": "Infoboard-app",
                    },
                    body: JSON.stringify({
                        query: `
                        {
                            stopPlace(id: "NSR:StopPlace:6435") {
                                id
                                name
                                estimatedCalls(timeRange: 72100, numberOfDepartures: 10) {
                                    realtime
                                    aimedArrivalTime
                                    expectedArrivalTime
                                    destinationDisplay {
                                        frontText
                                    }
                                    serviceJourney {
                                        journeyPattern {
                                            line {
                                                id
                                                transportMode
                                            }
                                        }
                                    }
                                }
                            }
                        }
                        `,
                    }),
                });



                departuresData = await response.json();
                showDepartures();
            } catch (error) {
                console.error("Fetch error:", error.message);
            }
        }

        function formatDepartureTime(expectedArrival) {
            const now = new Date();
            const timeDiff = Math.floor((expectedArrival - now) / 1000 / 60);

            if (timeDiff <= 0) return "nå";
            if (timeDiff <= 15) return timeDiff + " min";

            return expectedArrival.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit', hour12: false});
        }

        function showDepartures() {
            const sentrum = ["Kværnerbyen", "Ekeberg hageby"];
            const otherWay = ["Kjelsås stasjon", "Tåsen"];

            const calls = departuresData?.data?.stopPlace?.estimatedCalls || [];
            const containerSentrum = document.getElementById("departuresSentrum");
            const containerOtherWay = document.getElementById("departuresOtherWay");

            containerSentrum.innerHTML = "";
            containerOtherWay.innerHTML = "";

            for (let call of calls) {
                const frontText = call.destinationDisplay.frontText || "";
                const lineId = (call.serviceJourney?.journeyPattern?.line?.id || "").split(":").pop();
                const expectedArrival = new Date(call.expectedArrivalTime || call.aimedArrivalTime);

                const div = document.createElement("div");
                div.classList.add("departures");
                div.innerHTML = `
                    <div class="lineBox">
                        <span class="lineNumber">${lineId}</span>
                        <span class="lineName" title="${frontText}">${frontText}</span>
                    </div>
                    <span class="departureTime">${formatDepartureTime(expectedArrival)}</span>
                `;

                if (sentrum.includes(frontText)) containerSentrum.appendChild(div);
                else if (otherWay.includes(frontText)) containerOtherWay.appendChild(div);
                else {
                    // If it doesn't match either list, put it into the shorter column so both fill nicely
                    if (containerSentrum.childElementCount <= containerOtherWay.childElementCount) containerSentrum.appendChild(div);
                    else containerOtherWay.appendChild(div);
                }
            }

            // After updating the DOM, try to fit everything
            fitToViewport();
        }

        /* ---------- RESPONSIVE: two-column + scaling logic ----------

           Goal:
           - If content height does not fit in the viewport, switch to two-column layout
             (one column per direction) to reduce height.
           - If still doesn't fit, scale the entire board down so everything is visible
             without scrolling on any device/size.
           - Always keep no vertical scroll; body overflow is hidden.

        -------------------------------------------------------------*/

        function fitToViewport() {
            const board = document.getElementById('board');

            // Reset to single column and unscaled to measure natural size
            board.classList.remove('columns');
            board.style.transform = 'scale(1)';

            // Use requestAnimationFrame to ensure layout has updated
            requestAnimationFrame(() => {
                const boardW = board.scrollWidth;
                const boardH = board.scrollHeight;
                const viewportW = window.innerWidth - 40; // account for #app padding
                const viewportH = window.innerHeight - 40;

                // If it doesn't fit vertically, switch to two-column layout
                if (boardH > viewportH) {
                    board.classList.add('columns');
                } else {
                    board.classList.remove('columns');
                }

                // Re-measure after applying columns
                requestAnimationFrame(() => {
                    const newW = board.scrollWidth;
                    const newH = board.scrollHeight;

                    // Compute scale so it fits both width and height
                    const scale = Math.min(
                        viewportW / newW,
                        viewportH / newH,
                        1 // don't upscale beyond 1
                    );

                    board.style.transform = 'scale(' + scale + ')';
                });
            });
        }

        // Recompute layout on resize/orientation change
        window.addEventListener('resize', fitToViewport);
        window.addEventListener('orientationchange', () => {
            // small delay to allow orientation metrics to stabilize
            setTimeout(fitToViewport, 150);
        });

        // Keep fetching and showing departures
        setInterval(fetchDepartures, 30000);
        fetchDepartures();

        // Also refresh visible layout periodically to handle dynamic content changes
        setInterval(fitToViewport, 2500);
    </script>
</body>
</html>
